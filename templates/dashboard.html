<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>DNS Monitoring Dashboard ‚Ä¢ v2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  {% include '_base_style.html' %}
</head>
<body>
  <div id="config-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: #fff; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%;">
      <h2>Setup Configuration</h2>
      <p style="margin: 8px 0 16px; color: #666;">Please provide your API credentials to begin.</p>
      <form id="config-form">
        <div class="filter-group wide" style="grid-column: span 12; margin-bottom: 12px;">
          <label for="api-domain">Server Domain</label>
          <input id="api-domain" type="text" placeholder="e.g., demo.pm.appneta.com" required>
        </div>
        <div class="filter-group wide" style="grid-column: span 12; margin-bottom: 12px;">
          <label for="org-id">Organization ID</label>
          <input id="org-id" type="text" placeholder="e.g., 3" required>
        </div>
        <div class="filter-group wide" style="grid-column: span 12; margin-bottom: 12px;">
          <label for="api-token">API Token</label>
          <input id="api-token" type="text" placeholder="Token <YOUR_TOKEN>" required>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button type="submit" class="btn primary">Save and Continue</button>
        </div>
      </form>
    </div>
  </div>

  <div class="header-bar">
    <div class="header-bar-content">
        <h1><span style="font-size: 16px; color: #6A737D; margin-right: 6px;">üåê</span> DNS Monitoring Dashboard</h1>
        <div class="spacer"></div>
        <div class="auto-refresh" style="font-size: 12px; color: #586069;">
            Auto-refresh: ON <span style="color: #D1D5DA; margin: 0 4px;">|</span> Last updated: <span id="last-updated">...</span>
        </div>
    </div>
  </div>
  <div class="filter-bar">
    <input id="global-search" type="search" placeholder="Search domain, server, response code‚Ä¶" aria-label="Search" />
    <input type="text" id="time-range-picker" placeholder="Select a time range" style="width: 240px;">
    <button class="btn primary" id="apply-btn" title="Apply (Enter)">Apply</button>
    <div class="spacer"></div>
    <a class="btn" href="/servers">Servers</a>
    <a class="btn" href="/consistency">Consistency</a>
    <a class="btn" href="/time-compare">Time Compare</a>
    <a class="btn" href="/points">Points</a>
    <button class="btn" id="export-btn" title="Export CSV (e)">Export CSV</button>
    <button class="btn" id="save-view">Save View</button>
    <select id="saved-views" title="Load saved view">
      <option value="">Load saved view‚Ä¶</option>
    </select>
  </div>
  <div class="container">

    <!-- Stats -->
    <div class="dashboard-grid" aria-label="Summary statistics">
      <div class="metric-card">
        <div class="stat-label">Total Domains</div>
        <div class="stat-value" id="total-domains">-</div>
      </div>
      <div class="metric-card">
        <div class="stat-label">DNS Servers</div>
        <div class="stat-value" id="total-servers">-</div>
      </div>
      <div class="metric-card">
        <div class="stat-label">Monitoring Points</div>
        <div class="stat-value" id="total-appliances">-</div>
      </div>
      <div class="metric-card">
        <div class="stat-label">Error Rate (24h)</div>
        <div class="stat-value" id="error-rate">-</div>
      </div>
    </div>

    <!-- Main -->
    <div class="card">
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="monitor" role="tab" aria-selected="true">Monitor</button>
        <button class="tab" data-tab="compare" role="tab">Compare</button>
        <button class="tab" data-tab="issues" role="tab">Issues</button>
        <button class="tab" data-tab="trends" role="tab">Trends</button>


      </div>

      <!-- Monitor -->
      <div id="monitor-tab" class="tab-content active" role="tabpanel">
        <div class="filters" aria-label="Filters">
          <div class="filter-group wide">
            <label>Domain</label>
            <select id="domain-filter"><option value="">All Domains</option></select>
          </div>
          <div class="filter-group">
            <label>DNS Server</label>
            <select id="dns-server-filter"><option value="">All Servers</option></select>
          </div>
          <div class="filter-group">
            <label>Record Type</label>
            <select id="record-type-filter">
              <option value="">All Types</option><option>A</option><option>AAAA</option><option>CNAME</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Response Code</label>
            <select id="response-code-filter">
              <option value="">All</option><option>NOERROR</option><option>NXDOMAIN</option><option>SERVFAIL</option><option>REFUSED</option>
            </select>
          </div>
        </div>

        <div id="alerts-container"></div>

        <div class="card-title" style="margin-top:6px">
          Recent DNS Queries
          <div class="spacer"></div>
          <span id="result-count" style="font-size: 12px; color: var(--gray-700);">‚Äî</span>
        </div>

        <div style="overflow:auto; max-height: 520px;">
          <table class="data-table" aria-label="Recent DNS queries">
            <thead>
              <tr>
                <th class="sortable" data-sort="timestamp">Timestamp</th>
                <th class="sortable" data-sort="target_domain">Domain</th>
                <th class="sortable" data-sort="dns_server">DNS Server</th>
                <th class="sortable" data-sort="record_type">Type</th>
                <th class="sortable" data-sort="resolution_time">Response Time</th>
                <th class="sortable" data-sort="response_code">Response Code</th>
                <th>IPs</th>
              </tr>
            </thead>
            <tbody id="data-tbody">
              <tr><td colspan="7" style="text-align:center">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <button class="btn small ghost" id="prev-page">Prev</button>
          <span id="page-info" style="font-size: 12px; color: var(--gray-700);">Page 1</span>
          <button class="btn small ghost" id="next-page">Next</button>
          <select id="page-size" title="Rows per page">
            <option>50</option><option selected>100</option><option>200</option>
          </select>
        </div>
      </div>

      <!-- Compare -->
      <div id="compare-tab" class="tab-content" role="tabpanel" aria-hidden="true">
        <div class="filters">
          <div class="filter-group wide">
            <label>Select Domain to Compare</label>
            <select id="compare-domain"><option value="">Select a domain</option></select>
          </div>
          <div class="filter-group wide">
            <label>Select DNS Servers (optional)</label>
            <select id="compare-servers" multiple style="height:88px"></select>
          </div>
          <div class="filter-group">
            <label>Metric</label>
            <select id="compare-metric">
              <option value="avg">Avg (ms)</option>
              <option value="p95">p95 (ms)</option>
              <option value="err">Error Rate (%)</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn" id="compare-btn">Compare</button>
          </div>
        </div>
        <div id="comparison-results"></div>
        <div class="chart-container"><canvas id="comparison-chart"></canvas></div>
      </div>

      <!-- Issues -->
      <div id="issues-tab" class="tab-content" role="tabpanel" aria-hidden="true">
        <div class="card-title">DNS Issues & Anomalies</div>
        <h3 style="margin:14px 0 8px;color:#4a5568">‚ö†Ô∏è Slow Queries (>100ms)</h3>
        <div id="slow-queries-list"></div>
        <h3 style="margin:14px 0 8px;color:#4a5568">‚ùå Failed / Noisy Domains</h3>
        <div id="failed-domains-list"></div>
        <h3 style="margin:14px 0 8px;color:#4a5568">üß† Detected Anomalies (z-score &gt; 3)</h3>
        <div id="anomaly-list"></div>
      </div>

      <!-- Trends -->
      <div id="trends-tab" class="tab-content" role="tabpanel" aria-hidden="true">
        <div class="card-title">Performance Trends</div>
        <div class="filters">
          <div class="filter-group wide">
            <label>Select Domain</label>
            <select id="trend-domain"><option value="">Select a domain</option></select>
          </div>
          <div class="filter-group">
            <label>Window</label>
            <select id="trend-window">
              <option value="24">24h</option>
              <option value="168" selected>7d</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn" id="load-trends">Load Trends</button>
          </div>
        </div>
        <div class="chart-container"><canvas id="trends-chart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Domain Drawer -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <header>
      <h3 id="drawer-title">Domain</h3>
      <button class="btn small ghost" id="close-drawer">Close</button>
    </header>
    <div id="drawer-meta" class="link-row"></div>
    <div class="chart-container" style="height:220px"><canvas id="drawer-chart"></canvas></div>
    <div class="comparison-grid" id="drawer-grid" style="margin-top:8px"></div>
  </aside>

  <script>
    const API_BASE = '';
    let allData = [];
    let comparisonChart = null;
    let trendsChart = null;
    let drawerChart = null;
    let sort = { field: 'timestamp', dir: 'desc' };
    let page = 1, pageSize = 100, totalRows = 0;
    let savedFilters = {};
    let flatpickrInstance = null;

    // --- helpers ---
    const qs = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>Array.from(document.querySelectorAll(sel));
    const esc = encodeURIComponent;

    function saveStateToURL(){
      const p = new URLSearchParams({
        q: qs('#global-search').value || '',
        domain: qs('#domain-filter').value || '',
        dns: qs('#dns-server-filter').value || '',
        type: qs('#record-type-filter').value || '',
        code: qs('#response-code-filter').value || '',
        sort: `${sort.field}:${sort.dir}`,
        page, pageSize
      });
      if (flatpickrInstance && flatpickrInstance.selectedDates.length === 2) {
        p.append('start', flatpickrInstance.selectedDates[0].toISOString());
        p.append('end', flatpickrInstance.selectedDates[1].toISOString());
      }
      history.replaceState(null,'',`?${p.toString()}`);
    }
    function loadStateFromURL(){
      const p = new URLSearchParams(location.search);
      const set=(id,key)=>{const v=p.get(key)||'';const el=qs(id); if(el) el.value=v}
      set('#global-search','q');
      set('#domain-filter','domain');
      set('#dns-server-filter','dns');
      set('#record-type-filter','type');
      set('#response-code-filter','code');

      const start = p.get('start');
      const end = p.get('end');
      if (start && end) {
        flatpickrInstance.setDate([new Date(start), new Date(end)]);
      }

      const s = p.get('sort'); if(s){ const [f,d]=s.split(':'); sort={field:f||'timestamp',dir:d||'desc'} }
      page = parseInt(p.get('page')||'1',10);
      pageSize = parseInt(p.get('pageSize')||'100',10); qs('#page-size').value = pageSize;
    }

    // --- init ---
    document.addEventListener('DOMContentLoaded', async () => {
      qs('#config-form').addEventListener('submit', handleConfigSubmit);

      const savedConfig = JSON.parse(localStorage.getItem('dnsMonitorConfig'));
      if (savedConfig && savedConfig.api_base_url) {
        try {
            const url = new URL(savedConfig.api_base_url);
            qs('#api-domain').value = url.hostname;
        } catch(e) { /* ignore parse error */ }
        qs('#org-id').value = savedConfig.org_id;
        qs('#api-token').value = savedConfig.api_token;
      }

      try {
        const { data } = await axios.get(`${API_BASE}/api/status`);
        if (data.configured) {
          initializeApp();
        } else {
          if (savedConfig) {
            await submitConfig(savedConfig);
          } else {
            qs('#config-modal').style.display = 'flex';
          }
        }
      } catch (e) {
        console.error("Error checking server status", e);
        alert("Could not connect to the backend server.");
      }
    });

    async function handleConfigSubmit(e) {
        e.preventDefault();
        const domain = qs('#api-domain').value.trim();
        if (!domain) {
            alert("Please enter a server domain.");
            return;
        }
        const config = {
            api_base_url: `https://${domain}/api/v3/dns/webPath/data`,
            org_id: qs('#org-id').value.trim(),
            api_token: qs('#api-token').value.trim(),
        };
        await submitConfig(config);
    }

    async function submitConfig(config) {
        try {
            await axios.post(`${API_BASE}/api/config`, config);
            localStorage.setItem('dnsMonitorConfig', JSON.stringify(config));
            qs('#config-modal').style.display = 'none';
            initializeApp();
        } catch (error) {
            console.error('Configuration failed:', error);
            alert('Failed to apply configuration. Please check the values and server logs.');
        }
    }

    async function initializeApp() {
      flatpickrInstance = flatpickr("#time-range-picker", {
        mode: "range",
        enableTime: true,
        dateFormat: "Y-m-d H:i",
        defaultDate: [new Date(Date.now() - 24 * 3600 * 1000), new Date()]
      });

      attachEvents();
      await loadFilterOptions(); // domains/servers
      loadStateFromURL();
      await refreshStats();
      await loadData();
      await loadSavedViews();
      // live updates via SSE (best-effort)
      try {
        const es = new EventSource(`${API_BASE}/api/stream`);
        es.onmessage = (e)=>{ if(e?.data==='tick'){ refreshStats(); loadData(false /* keep page */); } };
      } catch {}
      // keyboard shortcuts
      document.addEventListener('keydown', (e)=>{
        if(e.key === '/') { e.preventDefault(); qs('#global-search').focus(); }
        if(e.key.toLowerCase() === 's') { e.preventDefault(); saveView(); }
        if(e.key.toLowerCase() === 'e') { e.preventDefault(); exportCSV(); }
        if(e.key === 'Enter' && document.activeElement.closest('input,select')) { applyFilters(); }
      });
    }

    function attachEvents(){
      // Tabs
      qsa('.tab').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          qsa('.tab').forEach(t=>t.classList.remove('active'));
          ev.currentTarget.classList.add('active');
          const name = ev.currentTarget.dataset.tab;
          qsa('.tab-content').forEach(c=>c.classList.remove('active'));
          qs(`#${name}-tab`).classList.add('active');
        });
      });
      // Sorting
      qsa('th.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const f = th.dataset.sort;
          if(sort.field === f){ sort.dir = sort.dir === 'asc' ? 'desc' : 'asc'; }
          else { sort = { field: f, dir: 'asc' }; }
          page = 1;
          loadData();
        });
      });
      // Filters
      qs('#apply-btn').addEventListener('click', applyFilters);
      qs('#page-size').addEventListener('change', ()=>{ pageSize=parseInt(qs('#page-size').value,10); page=1; loadData(); });
      qs('#prev-page').addEventListener('click', ()=>{ if(page>1){ page--; loadData(false);} });
      qs('#next-page').addEventListener('click', ()=>{ if(page*pageSize < totalRows){ page++; loadData(false);} });
      qs('#export-btn').addEventListener('click', exportCSV);
      qs('#save-view').addEventListener('click', saveView);
      qs('#saved-views').addEventListener('change', applySavedView);
      // Drawer
      qs('#close-drawer').addEventListener('click', closeDrawer);
      // Compare
      qs('#compare-btn').addEventListener('click', performComparison);
      // Trends
      qs('#load-trends').addEventListener('click', loadTrends);
    }

    async function loadFilterOptions(){
      try{
        const [domainsRes, serversRes] = await Promise.all([
          axios.get(`${API_BASE}/api/domains`),
          axios.get(`${API_BASE}/api/dns_servers`)
        ]);
        const domains = domainsRes.data||[], servers = serversRes.data||[];
        ['#domain-filter','#compare-domain','#trend-domain'].forEach(id=>{
          const el = qs(id); if(!el) return;
          const preserve = el.value;
          el.innerHTML = (id==='#domain-filter' ? '<option value="">All Domains</option>' : '<option value="">Select a domain</option>') +
            domains.map(d=>`<option>${d}</option>`).join('');
          if(preserve) el.value = preserve;
        });
        const serverFilter = qs('#dns-server-filter');
        serverFilter.innerHTML = '<option value="">All Servers</option>' + servers.map(s=>`<option>${s}</option>`).join('');
        const compareServers = qs('#compare-servers');
        compareServers.innerHTML = servers.map(s=>`<option>${s}</option>`).join('');
      }catch(e){ console.error(e); }
    }

    async function refreshStats(){
      try{
        const {data:stats} = await axios.get(`${API_BASE}/api/statistics`);
        qs('#total-domains').textContent = stats.total_domains||0;
        qs('#total-servers').textContent = stats.total_dns_servers||0;
        qs('#total-appliances').textContent = stats.total_appliances||0;

        const errors = Object.values(stats.error_counts||{}).reduce((a,b)=>a+b,0);
        const rate = stats.total_samples ? (errors / stats.total_samples * 100) : (errors ? 100 : 0);
        qs('#error-rate').textContent = stats.total_samples ? `${rate.toFixed(2)}%` : (errors ? `${errors} errors` : '0%');
        const ind = qs('#error-status');
        ind.className = 'status-indicator ' + (rate===0 ? 'status-good' : rate<1 ? 'status-warning' : 'status-error');

        // Issues: slow/failing/anomalies
        const slowList = qs('#slow-queries-list');
        slowList.innerHTML = (stats.slow_queries||[]).map(q=>`
          <div class="comparison-item">
            <strong>${q.target_domain}</strong><br/>
            DNS Server: ${q.dns_server}<br/>
            Avg: <span class="response-time response-slow">${Math.round(q.avg_time)}ms</span>
          </div>`).join('') || '<div>None</div>';

        const failList = qs('#failed-domains-list');
        failList.innerHTML = (stats.failing_domains||[]).map(d=>`
          <div class="comparison-item">
            <strong>${d.target_domain}</strong><br/>Errors: <strong style="color:var(--danger)">${d.error_count}</strong>
          </div>`).join('') || '<div>None</div>';

        const {data:anoms} = await axios.get(`${API_BASE}/api/anomalies`);
        qs('#anomaly-list').innerHTML = (anoms||[]).map(a=>`
          <div class="comparison-item">
            <strong>${a.target_domain}</strong> on <em>${a.dns_server}</em><br/>
            spike: ${Math.round(a.value)}ms (z=${a.z.toFixed(2)})
          </div>`).join('') || '<div>None detected</div>';

        // SLO pulse + burn rate (server side also available; light calc here)
        const obj = 99.9; // %
        qs('#slo-target').textContent = obj.toFixed(3) + '%';
        const burn = rate>0 ? (rate / (100 - obj)) : 0;
        qs('#burn-rate').textContent = burn ? burn.toFixed(2) + '√ó' : 'OK';
      }catch(e){ console.error('stats',e); }
    }

    function paramsFromUI(){
      return {
        q: qs('#global-search').value.trim(),
        domain: qs('#domain-filter').value,
        dns_server: qs('#dns-server-filter').value,
        record_type: qs('#record-type-filter').value,
        response_code: qs('#response-code-filter').value
      };
    }

    async function loadData(resetPage=true){
      try{
        if(resetPage) page=1;
        const filters = paramsFromUI();
        const p = new URLSearchParams();
        Object.entries(filters).forEach(([k,v])=>{ if(v) p.append(k,v); });
        if (flatpickrInstance && flatpickrInstance.selectedDates.length === 2) {
            p.append('start', flatpickrInstance.selectedDates[0].getTime());
            p.append('end', flatpickrInstance.selectedDates[1].getTime());
        }
        p.append('page', page);
        p.append('page_size', pageSize);
        p.append('sort', `${sort.field}:${sort.dir}`);
        const {data} = await axios.get(`${API_BASE}/api/data?${p.toString()}`);
        totalRows = data.total || (data.rows?.length||0);
        allData = data.rows || data; // backward compat if server not updated
        displayData(allData);
        checkForAlerts(allData);
        qs('#result-count').textContent = `${totalRows} rows`;
        qs('#page-info').textContent = `Page ${page}`;
        saveStateToURL();
      }catch(e){
        console.error(e);
        qs('#data-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red">Error loading data</td></tr>';
      }
    }

    function displayData(data){
      const tbody = qs('#data-tbody');
      if(!data.length){ tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No data</td></tr>'; return; }
      tbody.innerHTML = data.map(record=>{
        const dt = new Date(record.timestamp);
        const cls = record.resolution_time<50?'response-fast':record.resolution_time<100?'response-medium':'response-slow';
        const ips = (record.resolved_ips?.length? record.resolved_ips.slice(0,2).join(', ') + (record.resolved_ips.length>2?'‚Ä¶':'') : 'None');
        return `<tr>
          <td>${dt.toLocaleString()}</td>
          <td><button class="btn small ghost" onclick="openDomainDrawer('${record.target_domain}')">${record.target_domain}</button></td>
          <td>${record.dns_server}</td>
          <td>${record.record_type}</td>
          <td><span class="response-time ${cls}">${record.resolution_time}ms</span></td>
          <td>${record.response_code==='NOERROR' ? '<span style="color:var(--success)">‚úì NOERROR</span>' : '<span style="color:var(--danger)">‚úó '+record.response_code+'</span>'}</td>
          <td class="wrap" style="font-size:.85rem">${ips}</td>
        </tr>`;
      }).join('');
    }

    function checkForAlerts(data){
      const alerts = [];
      const errors = data.filter(d=>d.response_code!=='NOERROR');
      if(data.length && errors.length > data.length * 0.1){
        alerts.push({type:'error', message:`High error rate: ${Math.round(errors.length / data.length * 100)}% failing`});
      }
      const slow = data.filter(d=>d.resolution_time>100);
      if(data.length && slow.length > data.length * 0.2){
        alerts.push({type:'warning', message:`Performance degradation: ${Math.round(slow.length / data.length * 100)}% slow (>100ms)`});
      }
      qs('#alerts-container').innerHTML = alerts.map(a=>`<div class="alert alert-${a.type}">${a.message}</div>`).join('');
    }

    function applyFilters(){
      if (flatpickrInstance && flatpickrInstance.selectedDates.length === 2) {
        const start = flatpickrInstance.selectedDates[0].getTime();
        const end = flatpickrInstance.selectedDates[1].getTime();

        const applyBtn = qs('#apply-btn');
        applyBtn.disabled = true;
        applyBtn.textContent = 'Fetching...';

        axios.post(`${API_BASE}/api/fetch_data`, { start, end })
          .then(response => {
            console.log(response.data.message);
            loadData();
            applyBtn.disabled = false;
            applyBtn.textContent = 'Apply';
          })
          .catch(error => {
            console.error("Error initiating data fetch:", error);
            alert("Failed to start data fetch.");
            applyBtn.disabled = false;
            applyBtn.textContent = 'Apply';
          });
      } else {
        loadData();
      }
    }

    // --- Domain drawer ---
    async function openDomainDrawer(domain){
      const drawer = qs('#drawer');
      qs('#drawer-title').textContent = domain;
      qs('#drawer').setAttribute('aria-hidden','false');
      drawer.classList.add('open');
      // Meta links
      qs('#drawer-meta').innerHTML = `
        <a href="https://dnschecker.org/#A/${domain}" target="_blank">DNSChecker A</a>
        <a href="https://www.whatsmydns.net/#A/${domain}" target="_blank">WhatsMyDNS</a>
        <a href="https://toolbox.googleapps.com/apps/dig/#A/${domain}" target="_blank">Dig</a>
      `;
      // Fetch summary
      const params = new URLSearchParams({ domain: domain });
      if (flatpickrInstance && flatpickrInstance.selectedDates.length === 2) {
        params.append('start', flatpickrInstance.selectedDates[0].getTime());
        params.append('end', flatpickrInstance.selectedDates[1].getTime());
      } else {
        params.append('hours', 24); // fallback
      }
      const {data:s} = await axios.get(`${API_BASE}/api/domain_summary?${params.toString()}`);
      // Grid
      const grid = qs('#drawer-grid');
      const pct = (n)=> (n!=null? n.toFixed(2)+'%':'‚Äî');
      grid.innerHTML = `
        <div class="comparison-item"><strong>Samples</strong><br>${s.samples||0}</div>
        <div class="comparison-item"><strong>Error rate</strong><br>${pct(s.error_rate)}</div>
        <div class="comparison-item"><strong>p50</strong><br>${Math.round(s.p50||0)}ms</div>
        <div class="comparison-item"><strong>p95</strong><br>${Math.round(s.p95||0)}ms</div>
        <div class="comparison-item"><strong>p99</strong><br>${Math.round(s.p99||0)}ms</div>
        <div class="comparison-item"><strong>Servers</strong><br>${(s.servers||[]).length}</div>
      ` + (s.server_breakdown||[]).map(b=>`
        <div class="comparison-item">
          <strong>${b.dns_server}</strong><br/>
          avg ${Math.round(b.avg)}ms ‚Ä¢ p95 ${Math.round(b.p95)}ms<br/>
          errors ${b.errors}/${b.count}
        </div>`).join('');
      // Chart
      const ctx = qs('#drawer-chart').getContext('2d');
      if(drawerChart) drawerChart.destroy();
      const labels = s.timeseries?.map(t=>new Date(t.ts).toLocaleTimeString())||[];
      const avg = s.timeseries?.map(t=>t.avg)||[];
      const p95 = s.timeseries?.map(t=>t.p95)||[];
      const err = s.timeseries?.map(t=>t.err_rate)||[];
      drawerChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          {label:'Avg (ms)', data:avg, borderColor:'var(--primary)', backgroundColor:'rgba(3,102,214,.1)', yAxisID:'y', tension:.3},
          {label:'p95 (ms)', data:p95, borderColor:'var(--success)', backgroundColor:'rgba(40,167,69,.1)', yAxisID:'y', tension:.3},
          {label:'Error %', data:err, borderColor:'var(--danger)', backgroundColor:'rgba(220,53,69,.08)', yAxisID:'y1', tension:.3}
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          scales:{ y:{beginAtZero:true, title:{display:true,text:'ms'}}, y1:{beginAtZero:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'%'}} }
        }
      });
    }
    function closeDrawer(){
      const drawer = qs('#drawer'); drawer.classList.remove('open'); qs('#drawer').setAttribute('aria-hidden','true');
    }

    // --- Compare ---
    async function performComparison(){
      const domain = qs('#compare-domain').value;
      if(!domain){ alert('Pick a domain'); return; }
      const selected = Array.from(qs('#compare-servers').selectedOptions).map(o=>o.value);
      const params = new URLSearchParams({ domain });
      selected.forEach(s=>params.append('servers[]', s));
      const {data} = await axios.get(`${API_BASE}/api/compare?${params.toString()}`);
      displayComparison(data);
    }
    function displayComparison(data){
      const metric = qs('#compare-metric').value;
      const resultsDiv = qs('#comparison-results');
      // group by server
      const byServer = {};
      data.forEach(d=>{
        byServer[d.dns_server] ||= { rec:{}, avg_time:0, p95:0, err:0, _samples:0, _errors:0 };
        byServer[d.dns_server].rec[d.record_type] = d;
        byServer[d.dns_server]._samples += d.sample_count||0;
        byServer[d.dns_server]._errors += d.error_count||0;
      });
      Object.values(byServer).forEach(s=>{
        const vals = Object.values(s.rec);
        s.avg_time = vals.reduce((a,b)=>a+(b.avg_time||0),0)/(vals.length||1);
        s.p95 = vals.reduce((a,b)=>a+(b.p95||b.avg_time||0),0)/(vals.length||1);
        s.err = s._samples? (s._errors/s._samples*100) : 0;
      });
      resultsDiv.innerHTML = '<div class="comparison-grid">'+Object.entries(byServer).map(([srv,v])=>`
        <div class="comparison-item">
          <h4 style="color:#4a5568;margin-bottom:6px">${srv}</h4>
          <div>Avg: <strong>${Math.round(v.avg_time)}ms</strong></div>
          <div>p95: <strong>${Math.round(v.p95)}ms</strong></div>
          <div>Error: <strong style="color:${v.err>0?'var(--danger)':'var(--success)'}">${v.err.toFixed(2)}%</strong></div>
          <div style="margin-top:8px;font-size:.86rem">
            ${Object.entries(v.rec).map(([type, st])=>`${type}: ${Math.round(st.avg_time)}ms (${st.min_time}-${st.max_time}ms)`).join('<br/>')}
          </div>
        </div>`).join('') + '</div>';
      updateComparisonChart(data, metric);
    }
    function updateComparisonChart(data, metric){
      const ctx = qs('#comparison-chart').getContext('2d');
      const servers = [...new Set(data.map(d=>d.dns_server))];
      const rtypes = [...new Set(data.map(d=>d.record_type))];
      const datasets = rtypes.map((t,i)=>({
        label:t,
        data: servers.map(s=>{
          const item = data.find(d=>d.dns_server===s && d.record_type===t);
          if(!item) return 0;
          if(metric==='avg') return item.avg_time||0;
          if(metric==='p95') return item.p95||item.avg_time||0;
          if(metric==='err') return item.sample_count? (item.error_count/item.sample_count*100):0;
          return 0;
        }),
        backgroundColor: ['var(--primary)','var(--success)','var(--warning)','var(--info)','var(--gray-600)'][i%5]
      }));
      if(comparisonChart) comparisonChart.destroy();
      comparisonChart = new Chart(ctx,{
        type:'bar',
        data:{labels:servers,datasets},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{title:{display:true,text: metric==='err'?'Error Rate (%)':'Response Time (ms)'}} ,
          scales:{y:{beginAtZero:true,title:{display:true,text: metric==='err'?'%':'ms'}, grid: {color: 'var(--gray-200)'}}, x: {grid: {display:false}}}}
      });
    }

    // --- Trends ---
    async function loadTrends(){
      const domain = qs('#trend-domain').value;
      if(!domain){ alert('Pick a domain'); return; }
      const hours = qs('#trend-window').value;
      const {data:s} = await axios.get(`${API_BASE}/api/domain_summary?domain=${esc(domain)}&hours=${hours}`);
      const labels = s.timeseries.map(t=>new Date(t.ts).toLocaleString());
      const avg = s.timeseries.map(t=>t.avg);
      const p95 = s.timeseries.map(t=>t.p95);
      const err = s.timeseries.map(t=>t.err_rate);
      const ctx = qs('#trends-chart').getContext('2d');
      if(trendsChart) trendsChart.destroy();
      trendsChart = new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[
          {label:'Avg (ms)', data:avg, borderColor:'var(--primary)', backgroundColor:'rgba(3,102,214,.1)', yAxisID:'y', tension:.35},
          {label:'p95 (ms)', data:p95, borderColor:'var(--success)', backgroundColor:'rgba(40,167,69,.1)', yAxisID:'y', tension:.35},
          {label:'Error %', data:err, borderColor:'var(--danger)', backgroundColor:'rgba(220,53,69,.08)', yAxisID:'y1', tension:.35},
        ]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          scales:{
            y:{title:{display:true,text:'ms'}, beginAtZero:true, grid: {color: 'var(--gray-200)'}},
            y1:{position:'right', grid:{drawOnChartArea:false}, beginAtZero:true, title:{display:true,text:'%'}}
          }
        }
      });
    }

    // --- Saved Views ---
    async function saveView(){
      const name = prompt('Name this view (unique):'); if(!name) return;
      const payload = { name, filters: paramsFromUI(), sort, pageSize };
      try{
        await axios.post(`${API_BASE}/api/saved_views`, payload);
        await loadSavedViews();
        qs('#saved-views').value = name;
      }catch(e){ alert('Could not save‚Äîmaybe the name already exists?'); }
    }
    async function loadSavedViews(){
      try{
        const {data} = await axios.get(`${API_BASE}/api/saved_views`);
        const sel = qs('#saved-views');
        const current = sel.value;
        sel.innerHTML = '<option value="">Load saved view‚Ä¶</option>' + data.map(v=>`<option>${v.name}</option>`).join('');
        if(current) sel.value = current;
      }catch(e){ /* ignore */ }
    }
    async function applySavedView(){
      const name = qs('#saved-views').value; if(!name) return;
      const {data} = await axios.get(`${API_BASE}/api/saved_views/${esc(name)}`);
      const f = data.filters||{};
      qs('#global-search').value = f.q||'';
      qs('#domain-filter').value = f.domain||'';
      qs('#dns-server-filter').value = f.dns_server||'';
      qs('#record-type-filter').value = f.record_type||'';
      qs('#response-code-filter').value = f.response_code||'';
      if (f.start && f.end) {
        flatpickrInstance.setDate([new Date(f.start), new Date(f.end)]);
      }
      sort = data.sort||sort;
      pageSize = data.pageSize||pageSize; qs('#page-size').value = pageSize;
      await loadData();
    }

    // --- Export ---
    function exportCSV(){
      const f = paramsFromUI();
      const p = new URLSearchParams();
      Object.entries(f).forEach(([k,v])=>{ if(v) p.append(k,v); });
      if (flatpickrInstance && flatpickrInstance.selectedDates.length === 2) {
        p.append('start', flatpickrInstance.selectedDates[0].getTime());
        p.append('end', flatpickrInstance.selectedDates[1].getTime());
      }
      p.append('sort', `${sort.field}:${sort.dir}`);
      p.append('limit', Math.max(1000, pageSize)); // safe default
      const link = document.createElement('a');
      link.href = `${API_BASE}/api/export?${p.toString()}`;
      link.download = 'dns_export.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

  </script>
</body>
</html>
