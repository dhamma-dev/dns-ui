<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta
    name="viewport"
    content="width=device-width, initial-scale=1, viewport-fit=cover"
  />
  <title>DNS Monitoring Dashboard ‚Ä¢ v2</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <style>
    :root{
      --bg1:#667eea; --bg2:#764ba2; --ink:#2d3748; --muted:#718096;
      --good:#48bb78; --warn:#ed8936; --bad:#f56565; --card:#fff; --edge:#e2e8f0;
      --chip:#f7fafc; --chip2:#edf2f7;
    }
    *{margin:0;padding:0;box-sizing:border-box}
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;padding:20px;color:var(--ink)
    }
    .container{max-width:1400px;margin:0 auto}
    .header{background:var(--card);border-radius:15px;padding:22px 22px 12px;margin-bottom:18px;box-shadow:0 10px 30px rgba(0,0,0,.1)}
    .header-top{display:flex;gap:14px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:1.6rem}
    .subtitle{color:var(--muted);font-size:.95rem}
    .pulse{display:flex;gap:12px;align-items:center}
    .pulse .chip{background:var(--chip);padding:6px 10px;border-radius:999px;border:1px solid var(--edge);font-size:.85rem}
    .dashboard-grid{
      display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin-bottom:18px
    }
    .card{
      background:var(--card);border-radius:12px;padding:16px;box-shadow:0 4px 15px rgba(0,0,0,.08);
      transition:transform .2s ease,box-shadow .2s ease
    }
    .card:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,0,0,.12)}
    .card-title{font-weight:600;color:#4a5568;margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
    .filters{
      display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:12px
    }
    .filter-group{grid-column:span 3;display:flex;flex-direction:column}
    .filter-group.wide{grid-column:span 6}
    .filter-group label{font-size:.82rem;color:var(--muted);margin-bottom:4px;font-weight:500}
    select,input{
      padding:8px 12px;border:1px solid var(--edge);border-radius:8px;background:#fff;color:var(--ink);font-size:.92rem
    }
    .btn{
      padding:10px 14px;background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      color:#fff;border:none;border-radius:8px;font-weight:600;cursor:pointer
    }
    .btn.secondary{background:#48bb78}
    .btn.ghost{background:#fff;color:var(--ink);border:1px solid var(--edge)}
    .btn.small{padding:6px 10px;border-radius:6px;font-weight:500}
    .btn + .btn{margin-left:8px}
    .stat-value{font-size:1.8rem;font-weight:800;margin-bottom:4px}
    .stat-label{font-size:.8rem;color:#a0aec0;letter-spacing:.05em;text-transform:uppercase}
    .status-indicator{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:8px}
    .status-good{background:var(--good)} .status-warning{background:var(--warn)} .status-error{background:var(--bad)}
    .tabs{display:flex;gap:8px;margin-bottom:12px;border-bottom:2px solid var(--edge)}
    .tab{padding:10px 14px;background:none;border:none;color:var(--muted);cursor:pointer;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px}
    .tab.active{color:var(--bg1);border-bottom-color:var(--bg1)}
    .tab-content{display:none}.tab-content.active{display:block}
    table{width:100%;border-collapse:collapse}
    thead{background:#f7fafc;position:sticky;top:0;z-index:1}
    th,td{padding:10px;border-bottom:1px solid var(--edge);font-size:.92rem;text-align:left;white-space:nowrap}
    td.wrap{white-space:normal}
    th.sortable{cursor:pointer}
    .response-time{display:inline-block;padding:2px 8px;border-radius:999px;font-weight:600}
    .response-fast{background:#c6f6d5;color:#22543d}
    .response-medium{background:#fed7aa;color:#7c2d12}
    .response-slow{background:#fed7d7;color:#742a2a}
    .alert{padding:12px;border-radius:8px;margin:10px 0}
    .alert-warning{background:#fef5e7;border-left:4px solid #f39c12;color:#856404}
    .alert-error{background:#fee;border-left:4px solid #dc3545;color:#721c24}
    .chart-container{position:relative;height:300px;margin-top:12px}
    .comparison-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:10px;margin-top:10px}
    .comparison-item{padding:12px;background:var(--chip);border-radius:10px;border:1px solid var(--edge)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .spacer{flex:1}
    .pill{background:var(--chip2);padding:6px 10px;border-radius:999px;border:1px solid var(--edge);font-size:.82rem}
    .pagination{display:flex;gap:8px;align-items:center;justify-content:flex-end;margin-top:8px}
    .kbd{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;padding:2px 6px;border:1px solid var(--edge);border-bottom-width:2px;border-radius:6px;background:#fff;font-size:.8rem}
    /* Drawer */
    .drawer{position:fixed;top:0;right:-520px;width:520px;max-width:100%;height:100vh;background:#fff;box-shadow:-12px 0 40px rgba(0,0,0,.16);transition:right .28s ease;padding:18px 16px 22px;z-index:1000;overflow:auto}
    .drawer.open{right:0}
    .drawer header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .drawer h3{font-size:1.1rem}
    .link-row{display:flex;gap:6px;flex-wrap:wrap;margin:6px 0}
    .link-row a{font-size:.82rem;color:#4a67ea;text-decoration:none;border:1px solid var(--edge);padding:4px 8px;border-radius:6px;background:#fff}
    @media (max-width:900px){.filter-group{grid-column:span 6}.filter-group.wide{grid-column:span 12}}
  </style>
</head>
<body>
  <div id="config-modal" style="display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; align-items: center; justify-content: center;">
    <div style="background: #fff; padding: 30px; border-radius: 12px; width: 500px; max-width: 90%;">
      <h2>Setup Configuration</h2>
      <p style="margin: 8px 0 16px; color: #666;">Please provide your API credentials to begin.</p>
      <form id="config-form">
        <div class="filter-group wide" style="grid-column: span 12; margin-bottom: 12px;">
          <label for="api-domain">Server Domain</label>
          <input id="api-domain" type="text" placeholder="e.g., demo.pm.appneta.com" required>
        </div>
        <div class="filter-group wide" style="grid-column: span 12; margin-bottom: 12px;">
          <label for="org-id">Organization ID</label>
          <input id="org-id" type="text" placeholder="e.g., 3" required>
        </div>
        <div class="filter-group wide" style="grid-column: span 12; margin-bottom: 12px;">
          <label for="api-token">API Token</label>
          <input id="api-token" type="text" placeholder="Token <YOUR_TOKEN>" required>
        </div>
        <div style="text-align: right; margin-top: 20px;">
            <button type="submit" class="btn">Save and Continue</button>
        </div>
      </form>
    </div>
  </div>

  <div class="container">
    <div class="header" role="banner">
      <div class="header-top">
        <div class="toolbar" style="margin-top:8px">
  <a class="btn ghost small" href="/servers">Servers</a>
  <a class="btn ghost small" href="/consistency">Consistency</a>
  <a class="btn ghost small" href="/time-compare">Time Compare</a>
   <a class="btn ghost small" href="/points">Points</a>
</div>
        <div>
          <h1>üåê DNS Monitoring Dashboard <span class="pill">v2</span></h1>
          <p class="subtitle">Real-time DNS performance, anomalies & ops signals</p>
        </div>
        <div class="pulse" aria-label="SLO pulse">
          <span class="chip" id="slo-chip">SLO: <strong id="slo-target">99.9%</strong></span>
          <span class="chip">Burn rate: <strong id="burn-rate">‚Äî</strong></span>
          <button class="btn small ghost" id="export-btn" title="Export CSV (e)">Export CSV</button>
        </div>
      </div>
      <div class="toolbar" style="margin-top:12px">
        <input id="global-search" type="search" placeholder="Search domain, server, response code‚Ä¶" aria-label="Search (press /)" style="flex:1;min-width:220px" />
        <select id="time-range-filter" aria-label="Time Range">
          <option value="1">Last Hour</option>
          <option value="6">Last 6 Hours</option>
          <option value="24" selected>Last 24 Hours</option>
          <option value="72">Last 3 Days</option>
          <option value="168">Last Week</option>
        </select>
        <button class="btn" id="apply-btn" title="Apply (Enter)">Apply</button>
        <div class="spacer"></div>
        <button class="btn small ghost" id="save-view">Save View (s)</button>
        <select id="saved-views" title="Load saved view" style="min-width:180px">
          <option value="">Load saved view‚Ä¶</option>
        </select>
      </div>
    </div>

    <!-- Stats -->
    <div class="dashboard-grid" aria-label="Summary statistics">
      <div class="card">
        <div class="card-title">Total Domains <span class="status-indicator status-good"></span></div>
        <div class="stat-value" id="total-domains">-</div><div class="stat-label">Monitored Domains</div>
      </div>
      <div class="card">
        <div class="card-title">DNS Servers <span class="status-indicator status-good"></span></div>
        <div class="stat-value" id="total-servers">-</div><div class="stat-label">Active Servers</div>
      </div>
      <div class="card">
        <div class="card-title">Monitoring Points <span class="status-indicator status-good"></span></div>
        <div class="stat-value" id="total-appliances">-</div><div class="stat-label">Active Appliances</div>
      </div>
      <div class="card">
        <div class="card-title">Error Rate <span class="status-indicator" id="error-status"></span></div>
        <div class="stat-value" id="error-rate">-</div><div class="stat-label">Last 24 Hours</div>
      </div>
    </div>

    <!-- Main -->
    <div class="card">
      <div class="tabs" role="tablist">
        <button class="tab active" data-tab="monitor" role="tab" aria-selected="true">Monitor</button>
        <button class="tab" data-tab="compare" role="tab">Compare</button>
        <button class="tab" data-tab="issues" role="tab">Issues</button>
        <button class="tab" data-tab="trends" role="tab">Trends</button>


      </div>

      <!-- Monitor -->
      <div id="monitor-tab" class="tab-content active" role="tabpanel">
        <div class="filters" aria-label="Filters">
          <div class="filter-group wide">
            <label>Domain</label>
            <select id="domain-filter"><option value="">All Domains</option></select>
          </div>
          <div class="filter-group">
            <label>DNS Server</label>
            <select id="dns-server-filter"><option value="">All Servers</option></select>
          </div>
          <div class="filter-group">
            <label>Record Type</label>
            <select id="record-type-filter">
              <option value="">All Types</option><option>A</option><option>AAAA</option><option>CNAME</option>
            </select>
          </div>
          <div class="filter-group">
            <label>Response Code</label>
            <select id="response-code-filter">
              <option value="">All</option><option>NOERROR</option><option>NXDOMAIN</option><option>SERVFAIL</option><option>REFUSED</option>
            </select>
          </div>
        </div>

        <div id="alerts-container"></div>

        <div class="card-title" style="margin-top:6px">
          Recent DNS Queries
          <div class="spacer"></div>
          <span class="pill" id="result-count">‚Äî</span>
        </div>

        <div style="overflow:auto; max-height: 520px;">
          <table class="data-table" aria-label="Recent DNS queries">
            <thead>
              <tr>
                <th class="sortable" data-sort="timestamp">Timestamp</th>
                <th class="sortable" data-sort="target_domain">Domain</th>
                <th class="sortable" data-sort="dns_server">DNS Server</th>
                <th class="sortable" data-sort="record_type">Type</th>
                <th class="sortable" data-sort="resolution_time">Response Time</th>
                <th class="sortable" data-sort="response_code">Response Code</th>
                <th>IPs</th>
              </tr>
            </thead>
            <tbody id="data-tbody">
              <tr><td colspan="7" style="text-align:center">Loading‚Ä¶</td></tr>
            </tbody>
          </table>
        </div>

        <div class="pagination">
          <button class="btn small ghost" id="prev-page">Prev</button>
          <span class="pill" id="page-info">Page 1</span>
          <button class="btn small ghost" id="next-page">Next</button>
          <select id="page-size" title="Rows per page">
            <option>50</option><option selected>100</option><option>200</option>
          </select>
        </div>
      </div>

      <!-- Compare -->
      <div id="compare-tab" class="tab-content" role="tabpanel" aria-hidden="true">
        <div class="filters">
          <div class="filter-group wide">
            <label>Select Domain to Compare</label>
            <select id="compare-domain"><option value="">Select a domain</option></select>
          </div>
          <div class="filter-group wide">
            <label>Select DNS Servers (optional)</label>
            <select id="compare-servers" multiple style="height:88px"></select>
          </div>
          <div class="filter-group">
            <label>Metric</label>
            <select id="compare-metric">
              <option value="avg">Avg (ms)</option>
              <option value="p95">p95 (ms)</option>
              <option value="err">Error Rate (%)</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn" id="compare-btn">Compare</button>
          </div>
        </div>
        <div id="comparison-results"></div>
        <div class="chart-container"><canvas id="comparison-chart"></canvas></div>
      </div>

      <!-- Issues -->
      <div id="issues-tab" class="tab-content" role="tabpanel" aria-hidden="true">
        <div class="card-title">DNS Issues & Anomalies</div>
        <h3 style="margin:14px 0 8px;color:#4a5568">‚ö†Ô∏è Slow Queries (>100ms)</h3>
        <div id="slow-queries-list"></div>
        <h3 style="margin:14px 0 8px;color:#4a5568">‚ùå Failed / Noisy Domains</h3>
        <div id="failed-domains-list"></div>
        <h3 style="margin:14px 0 8px;color:#4a5568">üß† Detected Anomalies (z-score &gt; 3)</h3>
        <div id="anomaly-list"></div>
      </div>

      <!-- Trends -->
      <div id="trends-tab" class="tab-content" role="tabpanel" aria-hidden="true">
        <div class="card-title">Performance Trends</div>
        <div class="filters">
          <div class="filter-group wide">
            <label>Select Domain</label>
            <select id="trend-domain"><option value="">Select a domain</option></select>
          </div>
          <div class="filter-group">
            <label>Window</label>
            <select id="trend-window">
              <option value="24">24h</option>
              <option value="168" selected>7d</option>
            </select>
          </div>
          <div class="filter-group">
            <label>&nbsp;</label>
            <button class="btn" id="load-trends">Load Trends</button>
          </div>
        </div>
        <div class="chart-container"><canvas id="trends-chart"></canvas></div>
      </div>
    </div>
  </div>

  <!-- Domain Drawer -->
  <aside class="drawer" id="drawer" aria-hidden="true">
    <header>
      <h3 id="drawer-title">Domain</h3>
      <button class="btn small ghost" id="close-drawer">Close</button>
    </header>
    <div id="drawer-meta" class="link-row"></div>
    <div class="chart-container" style="height:220px"><canvas id="drawer-chart"></canvas></div>
    <div class="comparison-grid" id="drawer-grid" style="margin-top:8px"></div>
  </aside>

  <script>
    const API_BASE = '';
    let allData = [];
    let comparisonChart = null;
    let trendsChart = null;
    let drawerChart = null;
    let sort = { field: 'timestamp', dir: 'desc' };
    let page = 1, pageSize = 100, totalRows = 0;
    let savedFilters = {};

    // --- helpers ---
    const qs = (sel)=>document.querySelector(sel);
    const qsa = (sel)=>Array.from(document.querySelectorAll(sel));
    const esc = encodeURIComponent;

    function saveStateToURL(){
      const p = new URLSearchParams({
        q: qs('#global-search').value || '',
        domain: qs('#domain-filter').value || '',
        dns: qs('#dns-server-filter').value || '',
        type: qs('#record-type-filter').value || '',
        code: qs('#response-code-filter').value || '',
        hours: qs('#time-range-filter').value,
        sort: `${sort.field}:${sort.dir}`,
        page, pageSize
      });
      history.replaceState(null,'',`?${p.toString()}`);
    }
    function loadStateFromURL(){
      const p = new URLSearchParams(location.search);
      const set=(id,key)=>{const v=p.get(key)||'';const el=qs(id); if(el) el.value=v}
      set('#global-search','q');
      set('#domain-filter','domain');
      set('#dns-server-filter','dns');
      set('#record-type-filter','type');
      set('#response-code-filter','code');
      set('#time-range-filter','hours');
      const s = p.get('sort'); if(s){ const [f,d]=s.split(':'); sort={field:f||'timestamp',dir:d||'desc'} }
      page = parseInt(p.get('page')||'1',10);
      pageSize = parseInt(p.get('pageSize')||'100',10); qs('#page-size').value = pageSize;
    }

    // --- init ---
    document.addEventListener('DOMContentLoaded', async () => {
      qs('#config-form').addEventListener('submit', handleConfigSubmit);

      const savedConfig = JSON.parse(localStorage.getItem('dnsMonitorConfig'));
      if (savedConfig && savedConfig.api_base_url) {
        try {
            const url = new URL(savedConfig.api_base_url);
            qs('#api-domain').value = url.hostname;
        } catch(e) { /* ignore parse error */ }
        qs('#org-id').value = savedConfig.org_id;
        qs('#api-token').value = savedConfig.api_token;
      }

      try {
        const { data } = await axios.get(`${API_BASE}/api/status`);
        if (data.configured) {
          initializeApp();
        } else {
          if (savedConfig) {
            await submitConfig(savedConfig);
          } else {
            qs('#config-modal').style.display = 'flex';
          }
        }
      } catch (e) {
        console.error("Error checking server status", e);
        alert("Could not connect to the backend server.");
      }
    });

    async function handleConfigSubmit(e) {
        e.preventDefault();
        const domain = qs('#api-domain').value.trim();
        if (!domain) {
            alert("Please enter a server domain.");
            return;
        }
        const config = {
            api_base_url: `https://${domain}/api/v3/dns/webPath/data`,
            org_id: qs('#org-id').value.trim(),
            api_token: qs('#api-token').value.trim(),
        };
        await submitConfig(config);
    }

    async function submitConfig(config) {
        try {
            // we don't await this, as the server will restart
            axios.post(`${API_BASE}/api/config`, config);
            localStorage.setItem('dnsMonitorConfig', JSON.stringify(config));
            qs('#config-modal').innerHTML = '<h2>Configuration saved. Server is restarting. Reloading page...</h2>';
            setTimeout(() => {
                location.reload();
            }, 2500);
        } catch (error) {
            // This part might not be reached if the server restarts quickly
            console.error('Configuration failed:', error);
            alert('Failed to apply configuration. Please check the values and server logs.');
        }
    }

    async function initializeApp() {
      attachEvents();
      await loadFilterOptions(); // domains/servers
      loadStateFromURL();
      await refreshStats();
      await loadData();
      await loadSavedViews();
      // live updates via SSE (best-effort)
      try {
        const es = new EventSource(`${API_BASE}/api/stream`);
        es.onmessage = (e)=>{ if(e?.data==='tick'){ refreshStats(); loadData(false /* keep page */); } };
      } catch {}
      // keyboard shortcuts
      document.addEventListener('keydown', (e)=>{
        if(e.key === '/') { e.preventDefault(); qs('#global-search').focus(); }
        if(e.key.toLowerCase() === 's') { e.preventDefault(); saveView(); }
        if(e.key.toLowerCase() === 'e') { e.preventDefault(); exportCSV(); }
        if(e.key === 'Enter' && document.activeElement.closest('input,select')) { applyFilters(); }
      });
    }

    function attachEvents(){
      // Tabs
      qsa('.tab').forEach(btn=>{
        btn.addEventListener('click', (ev)=>{
          qsa('.tab').forEach(t=>t.classList.remove('active'));
          ev.currentTarget.classList.add('active');
          const name = ev.currentTarget.dataset.tab;
          qsa('.tab-content').forEach(c=>c.classList.remove('active'));
          qs(`#${name}-tab`).classList.add('active');
        });
      });
      // Sorting
      qsa('th.sortable').forEach(th=>{
        th.addEventListener('click', ()=>{
          const f = th.dataset.sort;
          if(sort.field === f){ sort.dir = sort.dir === 'asc' ? 'desc' : 'asc'; }
          else { sort = { field: f, dir: 'asc' }; }
          page = 1;
          loadData();
        });
      });
      // Filters
      qs('#apply-btn').addEventListener('click', applyFilters);
      qs('#page-size').addEventListener('change', ()=>{ pageSize=parseInt(qs('#page-size').value,10); page=1; loadData(); });
      qs('#prev-page').addEventListener('click', ()=>{ if(page>1){ page--; loadData(false);} });
      qs('#next-page').addEventListener('click', ()=>{ if(page*pageSize < totalRows){ page++; loadData(false);} });
      qs('#export-btn').addEventListener('click', exportCSV);
      qs('#save-view').addEventListener('click', saveView);
      qs('#saved-views').addEventListener('change', applySavedView);
      // Drawer
      qs('#close-drawer').addEventListener('click', closeDrawer);
      // Compare
      qs('#compare-btn').addEventListener('click', performComparison);
      // Trends
      qs('#load-trends').addEventListener('click', loadTrends);
    }

    async function loadFilterOptions(){
      try{
        const [domainsRes, serversRes] = await Promise.all([
          axios.get(`${API_BASE}/api/domains`),
          axios.get(`${API_BASE}/api/dns_servers`)
        ]);
        const domains = domainsRes.data||[], servers = serversRes.data||[];
        ['#domain-filter','#compare-domain','#trend-domain'].forEach(id=>{
          const el = qs(id); if(!el) return;
          const preserve = el.value;
          el.innerHTML = (id==='#domain-filter' ? '<option value="">All Domains</option>' : '<option value="">Select a domain</option>') +
            domains.map(d=>`<option>${d}</option>`).join('');
          if(preserve) el.value = preserve;
        });
        const serverFilter = qs('#dns-server-filter');
        serverFilter.innerHTML = '<option value="">All Servers</option>' + servers.map(s=>`<option>${s}</option>`).join('');
        const compareServers = qs('#compare-servers');
        compareServers.innerHTML = servers.map(s=>`<option>${s}</option>`).join('');
      }catch(e){ console.error(e); }
    }

    async function refreshStats(){
      try{
        const {data:stats} = await axios.get(`${API_BASE}/api/statistics`);
        qs('#total-domains').textContent = stats.total_domains||0;
        qs('#total-servers').textContent = stats.total_dns_servers||0;
        qs('#total-appliances').textContent = stats.total_appliances||0;

        const errors = Object.values(stats.error_counts||{}).reduce((a,b)=>a+b,0);
        const rate = stats.total_samples ? (errors / stats.total_samples * 100) : (errors ? 100 : 0);
        qs('#error-rate').textContent = stats.total_samples ? `${rate.toFixed(2)}%` : (errors ? `${errors} errors` : '0%');
        const ind = qs('#error-status');
        ind.className = 'status-indicator ' + (rate===0 ? 'status-good' : rate<1 ? 'status-warning' : 'status-error');

        // Issues: slow/failing/anomalies
        const slowList = qs('#slow-queries-list');
        slowList.innerHTML = (stats.slow_queries||[]).map(q=>`
          <div class="comparison-item">
            <strong>${q.target_domain}</strong><br/>
            DNS Server: ${q.dns_server}<br/>
            Avg: <span class="response-time response-slow">${Math.round(q.avg_time)}ms</span>
          </div>`).join('') || '<div class="pill">None</div>';

        const failList = qs('#failed-domains-list');
        failList.innerHTML = (stats.failing_domains||[]).map(d=>`
          <div class="comparison-item">
            <strong>${d.target_domain}</strong><br/>Errors: <strong style="color:#dc3545">${d.error_count}</strong>
          </div>`).join('') || '<div class="pill">None</div>';

        const {data:anoms} = await axios.get(`${API_BASE}/api/anomalies`);
        qs('#anomaly-list').innerHTML = (anoms||[]).map(a=>`
          <div class="comparison-item">
            <strong>${a.target_domain}</strong> on <em>${a.dns_server}</em><br/>
            spike: ${Math.round(a.value)}ms (z=${a.z.toFixed(2)})
          </div>`).join('') || '<div class="pill">None detected</div>';

        // SLO pulse + burn rate (server side also available; light calc here)
        const obj = 99.9; // %
        qs('#slo-target').textContent = obj.toFixed(3) + '%';
        const burn = rate>0 ? (rate / (100 - obj)) : 0;
        qs('#burn-rate').textContent = burn ? burn.toFixed(2) + '√ó' : 'OK';
      }catch(e){ console.error('stats',e); }
    }

    function paramsFromUI(){
      return {
        q: qs('#global-search').value.trim(),
        domain: qs('#domain-filter').value,
        dns_server: qs('#dns-server-filter').value,
        record_type: qs('#record-type-filter').value,
        response_code: qs('#response-code-filter').value,
        time_range: qs('#time-range-filter').value
      };
    }

    async function loadData(resetPage=true){
      try{
        if(resetPage) page=1;
        const filters = paramsFromUI();
        const p = new URLSearchParams();
        Object.entries(filters).forEach(([k,v])=>{ if(v) p.append(k,v); });
        p.append('page', page);
        p.append('page_size', pageSize);
        p.append('sort', `${sort.field}:${sort.dir}`);
        const {data} = await axios.get(`${API_BASE}/api/data?${p.toString()}`);
        totalRows = data.total || (data.rows?.length||0);
        allData = data.rows || data; // backward compat if server not updated
        displayData(allData);
        checkForAlerts(allData);
        qs('#result-count').textContent = `${totalRows} rows`;
        qs('#page-info').textContent = `Page ${page}`;
        saveStateToURL();
      }catch(e){
        console.error(e);
        qs('#data-tbody').innerHTML = '<tr><td colspan="7" style="text-align:center;color:red">Error loading data</td></tr>';
      }
    }

    function displayData(data){
      const tbody = qs('#data-tbody');
      if(!data.length){ tbody.innerHTML = '<tr><td colspan="7" style="text-align:center">No data</td></tr>'; return; }
      tbody.innerHTML = data.map(record=>{
        const dt = new Date(record.timestamp);
        const cls = record.resolution_time<50?'response-fast':record.resolution_time<100?'response-medium':'response-slow';
        const ips = (record.resolved_ips?.length? record.resolved_ips.slice(0,2).join(', ') + (record.resolved_ips.length>2?'‚Ä¶':'') : 'None');
        return `<tr>
          <td>${dt.toLocaleString()}</td>
          <td><button class="btn small ghost" onclick="openDomainDrawer('${record.target_domain}')">${record.target_domain}</button></td>
          <td>${record.dns_server}</td>
          <td>${record.record_type}</td>
          <td><span class="response-time ${cls}">${record.resolution_time}ms</span></td>
          <td>${record.response_code==='NOERROR' ? '<span style="color:green">‚úì NOERROR</span>' : '<span style="color:#dc3545">‚úó '+record.response_code+'</span>'}</td>
          <td class="wrap" style="font-size:.85rem">${ips}</td>
        </tr>`;
      }).join('');
    }

    function checkForAlerts(data){
      const alerts = [];
      const errors = data.filter(d=>d.response_code!=='NOERROR');
      if(data.length && errors.length > data.length * 0.1){
        alerts.push({type:'error', message:`High error rate: ${Math.round(errors.length / data.length * 100)}% failing`});
      }
      const slow = data.filter(d=>d.resolution_time>100);
      if(data.length && slow.length > data.length * 0.2){
        alerts.push({type:'warning', message:`Performance degradation: ${Math.round(slow.length / data.length * 100)}% slow (>100ms)`});
      }
      qs('#alerts-container').innerHTML = alerts.map(a=>`<div class="alert alert-${a.type}">${a.message}</div>`).join('');
    }

    function applyFilters(){ loadData(); }

    // --- Domain drawer ---
    async function openDomainDrawer(domain){
      const drawer = qs('#drawer');
      qs('#drawer-title').textContent = domain;
      qs('#drawer').setAttribute('aria-hidden','false');
      drawer.classList.add('open');
      // Meta links
      qs('#drawer-meta').innerHTML = `
        <a href="https://dnschecker.org/#A/${domain}" target="_blank">DNSChecker A</a>
        <a href="https://www.whatsmydns.net/#A/${domain}" target="_blank">WhatsMyDNS</a>
        <a href="https://toolbox.googleapps.com/apps/dig/#A/${domain}" target="_blank">Dig</a>
      `;
      // Fetch summary
      const hours = qs('#time-range-filter').value || 24;
      const {data:s} = await axios.get(`${API_BASE}/api/domain_summary?domain=${esc(domain)}&hours=${hours}`);
      // Grid
      const grid = qs('#drawer-grid');
      const pct = (n)=> (n!=null? n.toFixed(2)+'%':'‚Äî');
      grid.innerHTML = `
        <div class="comparison-item"><strong>Samples</strong><br>${s.samples||0}</div>
        <div class="comparison-item"><strong>Error rate</strong><br>${pct(s.error_rate)}</div>
        <div class="comparison-item"><strong>p50</strong><br>${Math.round(s.p50||0)}ms</div>
        <div class="comparison-item"><strong>p95</strong><br>${Math.round(s.p95||0)}ms</div>
        <div class="comparison-item"><strong>p99</strong><br>${Math.round(s.p99||0)}ms</div>
        <div class="comparison-item"><strong>Servers</strong><br>${(s.servers||[]).length}</div>
      ` + (s.server_breakdown||[]).map(b=>`
        <div class="comparison-item">
          <strong>${b.dns_server}</strong><br/>
          avg ${Math.round(b.avg)}ms ‚Ä¢ p95 ${Math.round(b.p95)}ms<br/>
          errors ${b.errors}/${b.count}
        </div>`).join('');
      // Chart
      const ctx = qs('#drawer-chart').getContext('2d');
      if(drawerChart) drawerChart.destroy();
      const labels = s.timeseries?.map(t=>new Date(t.ts).toLocaleTimeString())||[];
      const avg = s.timeseries?.map(t=>t.avg)||[];
      const p95 = s.timeseries?.map(t=>t.p95)||[];
      const err = s.timeseries?.map(t=>t.err_rate)||[];
      drawerChart = new Chart(ctx, {
        type:'line',
        data:{ labels, datasets:[
          {label:'Avg (ms)', data:avg, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,.1)', yAxisID:'y', tension:.3},
          {label:'p95 (ms)', data:p95, borderColor:'#38a169', backgroundColor:'rgba(56,161,105,.1)', yAxisID:'y', tension:.3},
          {label:'Error %', data:err, borderColor:'#f56565', backgroundColor:'rgba(245,101,101,.08)', yAxisID:'y1', tension:.3}
        ]},
        options:{
          responsive:true, maintainAspectRatio:false, interaction:{mode:'index',intersect:false},
          scales:{ y:{beginAtZero:true, title:{display:true,text:'ms'}}, y1:{beginAtZero:true, position:'right', grid:{drawOnChartArea:false}, title:{display:true,text:'%'}} }
        }
      });
    }
    function closeDrawer(){
      const drawer = qs('#drawer'); drawer.classList.remove('open'); qs('#drawer').setAttribute('aria-hidden','true');
    }

    // --- Compare ---
    async function performComparison(){
      const domain = qs('#compare-domain').value;
      if(!domain){ alert('Pick a domain'); return; }
      const selected = Array.from(qs('#compare-servers').selectedOptions).map(o=>o.value);
      const params = new URLSearchParams({ domain });
      selected.forEach(s=>params.append('servers[]', s));
      const {data} = await axios.get(`${API_BASE}/api/compare?${params.toString()}`);
      displayComparison(data);
    }
    function displayComparison(data){
      const metric = qs('#compare-metric').value;
      const resultsDiv = qs('#comparison-results');
      // group by server
      const byServer = {};
      data.forEach(d=>{
        byServer[d.dns_server] ||= { rec:{}, avg_time:0, p95:0, err:0, _samples:0, _errors:0 };
        byServer[d.dns_server].rec[d.record_type] = d;
        byServer[d.dns_server]._samples += d.sample_count||0;
        byServer[d.dns_server]._errors += d.error_count||0;
      });
      Object.values(byServer).forEach(s=>{
        const vals = Object.values(s.rec);
        s.avg_time = vals.reduce((a,b)=>a+(b.avg_time||0),0)/(vals.length||1);
        s.p95 = vals.reduce((a,b)=>a+(b.p95||b.avg_time||0),0)/(vals.length||1);
        s.err = s._samples? (s._errors/s._samples*100) : 0;
      });
      resultsDiv.innerHTML = '<div class="comparison-grid">'+Object.entries(byServer).map(([srv,v])=>`
        <div class="comparison-item">
          <h4 style="color:#4a5568;margin-bottom:6px">${srv}</h4>
          <div>Avg: <strong>${Math.round(v.avg_time)}ms</strong></div>
          <div>p95: <strong>${Math.round(v.p95)}ms</strong></div>
          <div>Error: <strong style="color:${v.err>0?'#dc3545':'#28a745'}">${v.err.toFixed(2)}%</strong></div>
          <div style="margin-top:8px;font-size:.86rem">
            ${Object.entries(v.rec).map(([type, st])=>`${type}: ${Math.round(st.avg_time)}ms (${st.min_time}-${st.max_time}ms)`).join('<br/>')}
          </div>
        </div>`).join('') + '</div>';
      updateComparisonChart(data, metric);
    }
    function updateComparisonChart(data, metric){
      const ctx = qs('#comparison-chart').getContext('2d');
      const servers = [...new Set(data.map(d=>d.dns_server))];
      const rtypes = [...new Set(data.map(d=>d.record_type))];
      const datasets = rtypes.map((t,i)=>({
        label:t,
        data: servers.map(s=>{
          const item = data.find(d=>d.dns_server===s && d.record_type===t);
          if(!item) return 0;
          if(metric==='avg') return item.avg_time||0;
          if(metric==='p95') return item.p95||item.avg_time||0;
          if(metric==='err') return item.sample_count? (item.error_count/item.sample_count*100):0;
          return 0;
        }),
        backgroundColor: ['#667eea','#48bb78','#ed8936','#805ad5','#2b6cb0'][i%5],
        borderColor: ['#5a67d8','#38a169','#dd6b20','#6b46c1','#2c5282'][i%5],
        borderWidth:2
      }));
      if(comparisonChart) comparisonChart.destroy();
      comparisonChart = new Chart(ctx,{
        type:'bar',
        data:{labels:servers,datasets},
        options:{ responsive:true, maintainAspectRatio:false, plugins:{title:{display:true,text: metric==='err'?'Error Rate (%)':'Response Time (ms)'}} ,
          scales:{y:{beginAtZero:true,title:{display:true,text: metric==='err'?'%':'ms'}}}}
      });
    }

    // --- Trends ---
    async function loadTrends(){
      const domain = qs('#trend-domain').value;
      if(!domain){ alert('Pick a domain'); return; }
      const hours = qs('#trend-window').value;
      const {data} = await axios.get(`${API_BASE}/api/domain_summary?domain=${esc(domain)}&hours=${hours}`);
      const labels = data.timeseries.map(t=>new Date(t.ts).toLocaleString());
      const avg = data.timeseries.map(t=>t.avg);
      const p95 = data.timeseries.map(t=>t.p95);
      const err = data.timeseries.map(t=>t.err_rate);
      const ctx = qs('#trends-chart').getContext('2d');
      if(trendsChart) trendsChart.destroy();
      trendsChart = new Chart(ctx,{
        type:'line',
        data:{labels,datasets:[
          {label:'Avg (ms)', data:avg, borderColor:'#667eea', backgroundColor:'rgba(102,126,234,.1)', yAxisID:'y', tension:.35},
          {label:'p95 (ms)', data:p95, borderColor:'#38a169', backgroundColor:'rgba(56,161,105,.1)', yAxisID:'y', tension:.35},
          {label:'Error %', data:err, borderColor:'#f56565', backgroundColor:'rgba(245,101,101,.08)', yAxisID:'y1', tension:.35},
        ]},
        options:{
          responsive:true,
          maintainAspectRatio:false,
          interaction:{mode:'index',intersect:false},
          scales:{
            y:{title:{display:true,text:'ms'}, beginAtZero:true},
            y1:{position:'right', grid:{drawOnChartArea:false}, beginAtZero:true, title:{display:true,text:'%'}}
          }
        }
      }); // <- extra } was needed before this
    }

    // --- Saved Views ---
    async function saveView(){
      const name = prompt('Name this view (unique):'); if(!name) return;
      const payload = { name, filters: paramsFromUI(), sort, pageSize };
      try{
        await axios.post(`${API_BASE}/api/saved_views`, payload);
        await loadSavedViews();
        qs('#saved-views').value = name;
      }catch(e){ alert('Could not save‚Äîmaybe the name already exists?'); }
    }
    async function loadSavedViews(){
      try{
        const {data} = await axios.get(`${API_BASE}/api/saved_views`);
        const sel = qs('#saved-views');
        const current = sel.value;
        sel.innerHTML = '<option value="">Load saved view‚Ä¶</option>' + data.map(v=>`<option>${v.name}</option>`).join('');
        if(current) sel.value = current;
      }catch(e){ /* ignore */ }
    }
    async function applySavedView(){
      const name = qs('#saved-views').value; if(!name) return;
      const {data} = await axios.get(`${API_BASE}/api/saved_views/${esc(name)}`);
      const f = data.filters||{};
      qs('#global-search').value = f.q||'';
      qs('#domain-filter').value = f.domain||'';
      qs('#dns-server-filter').value = f.dns_server||'';
      qs('#record-type-filter').value = f.record_type||'';
      qs('#response-code-filter').value = f.response_code||'';
      qs('#time-range-filter').value = f.time_range||'24';
      sort = data.sort||sort;
      pageSize = data.pageSize||pageSize; qs('#page-size').value = pageSize;
      await loadData();
    }

    // --- Export ---
    function exportCSV(){
      const f = paramsFromUI();
      const p = new URLSearchParams();
      Object.entries(f).forEach(([k,v])=>{ if(v) p.append(k,v); });
      p.append('sort', `${sort.field}:${sort.dir}`);
      p.append('limit', Math.max(1000, pageSize)); // safe default
      const link = document.createElement('a');
      link.href = `${API_BASE}/api/export?${p.toString()}`;
      link.download = 'dns_export.csv';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

  </script>
</body>
</html>
