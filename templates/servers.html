<!doctype html>
<html>
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>DNS â€¢ Servers</title>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  {% include "_base_style.html" %}
</head>
<body>
  <div class="header-bar">
    <div class="header-bar-content">
        <h1><a href="/" style="text-decoration: none; color: inherit;">DNS Monitoring Dashboard</a> / Servers</h1>
        <div class="spacer"></div>
    </div>
  </div>
  <div class="filter-bar">
    <label for="hours" style="font-size: 12px; color: var(--gray-700);">Time Window (hours):</label>
    <select id="hours"><option>1</option><option>6</option><option selected>24</option><option>72</option><option>168</option></select>
    <button class="btn primary" onclick="loadPage()">Apply</button>
  </div>

  <div class="container" style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
    <div class="card">
      <h3 class="card-title" style="margin-top:0;">Top Offenders (by p95)</h3>
      <div style="overflow:auto;max-height:400px">
        <table id="tbl">
          <thead><tr><th>DNS Server</th><th>Samples</th><th>Error %</th><th>Avg</th><th>p95</th><th>p99</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
    <div class="card">
      <h3 class="card-title" style="margin-top:0;">p95 by Server</h3>
      <div class="chart-container" style="height:400px"><canvas id="chart"></canvas></div>
    </div>
  </div>

<script>
async function loadPage(){
  const h = document.getElementById('hours').value;
  const {data} = await axios.get(`/api/servers_summary?hours=${h}`);
  // table
  const tb = document.querySelector('#tbl tbody');
  if (!data || data.length === 0) {
    tb.innerHTML = '<tr><td colspan="6" style="text-align:center;">No data available for this timeframe.</td></tr>';
    return;
  }
  tb.innerHTML = data.map(r=>{
    return `<tr>
      <td>${r.dns_server}</td>
      <td>${r.samples}</td>
      <td><span class="response-time ${r.error_rate > 1 ? 'response-slow' : (r.error_rate > 0 ? 'response-medium' : 'response-fast')}">${r.error_rate.toFixed(2)}%</span></td>
      <td>${Math.round(r.avg)}ms</td>
      <td><strong>${Math.round(r.p95)}ms</strong></td>
      <td>${Math.round(r.p99)}ms</td>
    </tr>`;
  }).join('');

  // chart
  const labels = data.map(x=>x.dns_server);
  const vals = data.map(x=>Math.round(x.p95));
  const ctx = document.getElementById('chart').getContext('2d');
  if(window._ch) window._ch.destroy();
  window._ch = new Chart(ctx, {
    type: 'bar',
    data: { labels, datasets: [{
        label: 'p95 (ms)',
        data: vals,
        backgroundColor: vals.map(v => v > 100 ? 'var(--danger)' : (v > 50 ? 'var(--warning)' : 'var(--success)')),
    }] },
    options: {
        responsive:true,
        maintainAspectRatio:false,
        scales:{
            y:{ beginAtZero:true, title:{display:true,text:'ms'}, grid: { color: 'var(--gray-200)'} },
            x:{ grid: { display: false } }
        },
        plugins: { legend: { display: false } }
    }
  });
}
document.addEventListener('DOMContentLoaded', loadPage);
</script>
</body>
</html>
